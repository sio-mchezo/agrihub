<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="css/leaflet.css" crossorigin="" />

    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
      }

      .header {
        background-color: #2c3e50;
        color: white;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        margin: 0;
        font-size: 24px;
      }

      .map-container {
        position: relative;
        height: calc(100vh - 80px);
        width: 100%;
      }

      #map {
        display: block;
        height: 100%;
        height: 100vh;
        width: 100%;
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .error {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #e74c3c;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        z-index: 1000;
        max-width: 300px;
      }

      .info-panel {
        position: fixed;
        bottom: 10px;
        left: 10px;
        /* background: white; */
        /* padding: 15px; */
        /* border-radius: 8px; */
        /* box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); */
        z-index: 1000;
        max-width: 250px;
      }

      #count {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .pulsating-icon {
        background: transparent;
        width: 20px;
        height: 20px;
      }

      .pulse-circle {
        width: 20px;
        height: 20px;
        background: rgba(0, 123, 255, 0.6);
        border: 2px solid #007bff;
        border-radius: 50%;
        /* animation: pulse 1.5s infinite ease-in-out; */
        box-shadow: 0 0 0 rgba(0, 123, 255, 0.4);
      }

      #redx {
        background: red;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 0.9;
        }
        50% {
          transform: scale(1.5);
          opacity: 0.4;
        }
        100% {
          transform: scale(1);
          opacity: 0.9;
        }
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 20px;
        }

        .map-container {
          height: calc(100vh - 120px);
        }
      }

      .info-panel {
        position: absolute;
        bottom: 0;
        left: 0;
        margin: 10px;
        max-width: none;
      }

      .input-panel {
        position: absolute;
        bottom: 50px;
        left: 0;
        z-index: 99999;
      }
      select,
      input {
        display: block;
        margin: 2px;
        width: 100%;
      }
      .hidden {
        display: none;
      }
      #gradeInput {
        display: none;
      }
      #gradeInput.on {display: block;}
    </style>
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.6.1/css/all.css"
      integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="map-container">
      <div id="loading" class="loading">
        <p>Loading data...</p>
      </div>

      <div id="error" class="error" style="display: none">
        <p id="error-message"></p>
      </div>

      <div class="input-panel">
        <input
          type="text"
          id="name"
          placeholder="name"
          name="name"
          required
          minlength="4"
          maxlength="8"
          size="12"
        />

        <select oninput="swapOptions(value)">
          <option class="hidden" value="" selected disabled>crop</option>
          <option value="avocado">avocado</option>
          <option value="coffee">coffee</option>
          <option value="cashew">cashew</option>
        </select>

        <select id="selectInput">
          <option class="hidden" value="" selected disabled>type</option>
        </select>

        <select id="gradeInput">
          <option class="hidden" value="" selected disabled>grade</option>
        </select>
        
        <input
          type="number"
          id="weight"
          placeholder="weight (kg)"
          name="weight"
          min="10"
          size="8"
          max="100"
        />
        <input
          type="date"
          id="start"
          name="trip-start"
          value="2018-07-22"
          min="2018-01-01"
          max="2018-12-31"
        />

        <input
          type="text"
          id="id"
          placeholder="id"
          name="id"
          required
          minlength="4"
          maxlength="12"
          size="12"
        />
      </div>

      <div class="info-panel">
        <!-- <button onclick="swapOptions()">xxx</button> -->
        <!-- <div>count: <span id="count"></span></div>
        <a href="#" onclick="getlatlong()">get lat/long</a>
        <div id="latlong"></div> -->
      </div>

      <div id="map"></div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="js/leaflet.js" crossorigin=""></script>

    <!-- plugin -->
    <script src="js/Leaflet.Icon.Glyph.js"></script>

    <!-- PapaParse for CSV parsing -->
    <script src="js/papaparse.min.js"></script>

    <!-- media metadata info -->
    <script
      type="text/javascript"
      src="https://unpkg.com/mediainfo.js"
    ></script>

    <script>
      // const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/1eaWKPGi0BdU93PBPc-SNHrdVDxnhBBl2kZUZ1sa7OYo/export?format=csv';
      const GOOGLE_SHEETS_URL = "data/tz.csv";

      let map;
      let xMarkers = [];

      function initMap() {
        map = L.map("map").setView(
          [-3.4073399824389186, 36.95689894186733],
          13
        );

        // Define base layers
        const streetLayer = L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            attribution: "© OpenStreetMap contributors",
            maxZoom: 19,
          }
        );

        const satelliteLayer = L.tileLayer(
          "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
          {
            attribution:
              "Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community",
            maxZoom: 19,
          }
        );

        // Add default layer
        streetLayer.addTo(map);

        // Add layer control
        const baseLayers = {
          "Street Map": streetLayer,
          Satellite: satelliteLayer,
        };
        L.control.layers(baseLayers).addTo(map);

        loadCVS();

        map.on("click", function (e) {
          console.clear();
          //   document.getElementById("latlong").innerHTML =
          //     e.latlng.lat + " | " + e.latlng.lng;
          console.log(L.marker);

          //   addBarricadeMarker(e.latlng.lat, e.latlng.lng)
          // THIS WORKS <<<<<<<<<<<<<<<<<
          //  L.marker([e.latlng.lat, e.latlng.lng], {icon: L.icon.glyph({ prefix: 'fas', glyph: 'globe' }) }).addTo(map);
        });

        // setInterval(loadCVS, 2 * 60 * 1000);
      }

      async function loadCVS() {
        try {
          showLoading(true);
          hideError();

          const response = await fetch(GOOGLE_SHEETS_URL);
          const csvText = await response.text();
          // console.log(csvText)
          // name,latitude,longitude,crop,type,date,time,id

          Papa.parse(csvText, {
            header: true,
            complete: function (results) {
              const datapoint = results.data.filter(
                (row) =>
                  row.name &&
                  row.latitude &&
                  row.longitude &&
                  row.crop &&
                  row.type &&
                  row.weight &&
                  row.date &&
                  row.time &&
                  row.id
              );

              clearMarkers();
              datapoint.forEach((xpoint) => {
                addBarricadeMarker(xpoint);
              });
              //   updateBarricadeCount(datapoint.length);
              showLoading(false);
            },
            error: function (error) {
              console.error("Error parsing CSV:", error);
              showError("Error parsing data");
              showLoading(false);
            },
          });
        } catch (error) {
          console.error("Error fetching from Google Sheets:", error);
          showError("Failed to fetch data from Google Sheets");
          showLoading(false);
        }
      }

      var avocadoDb = ["hass", "fuerte", "zutano", "pinkerton", "gem"];
      var coffeeDb = ["arabica", "robusta"];
      var cashewDb = ["common", "tariko"];
      var gradesDb = ["WW180", "WW240", "WW320", "WS"];

      function swapOptions(value) {
        select = document.getElementById("selectInput");
        select.innerHTML = "";
        var thisval;

        if (value == "avocado") {
          thisval = avocadoDb;
        }
        if (value == "coffee") {
          thisval = coffeeDb;
        }
        if (value == "cashew") {
          thisval = cashewDb;
          document.getElementById("gradeInput").classList = 'on';
        } else {
          document.getElementById("gradeInput").classList = '';
        }

        for (var i = 0, n = thisval.length; i < n; i++) {
          var opt = document.createElement("option");
          opt.innerHTML = thisval[i];
          opt.thisval = value[i];
          select.appendChild(opt);
        }
      }

      function addBarricadeMarker(xpoint) {
        const lat = parseFloat(xpoint.latitude);
        const lng = parseFloat(xpoint.longitude);

        if (isNaN(lat) || isNaN(lng)) {
          console.warn("Invalid coordinates for xpoint:", xpoint);
          return;
        }

        const customIcon = L.divIcon({
          className: "pulsating-icon",
          iconSize: [20, 20],
          iconAnchor: [10, 10],
          popupAnchor: [0, -10],
          html: '<div class="pulse-circle"></div>',
        });

        const marker = L.marker([lat, lng], { icon: customIcon });

        //   if (xpoint.name == 'delmonte') {
        //     console.log('xx')
        //   }

        // specify popup options
        const customOptions = {
          maxWidth: 400,
          width: 200,
          className: "redx",
          id: "redx",
        };

        const popupContent = `
        <div style="min-width: 200px;">
          <h3 style="margin: 0 0 10px 0; color: #2c3e50;">${xpoint.name}</h3>
          <p><strong>crop:</strong> ${xpoint.crop}</p>
          <p><strong>type:</strong> ${xpoint.type}</p>
          <p><strong>weight:</strong> ${xpoint.weight}</p>
          <p><strong>date:</strong> ${xpoint.date}</p>
          <p><strong>id:</strong> ${xpoint.id}</p>
        </div>
      `;

        marker.bindPopup(popupContent);
        // marker.bindPopup(popupContent, customOptions);
        marker.addTo(map);
        xMarkers.push(marker);
      }

      function clearMarkers() {
        xMarkers.forEach((marker) => {
          map.removeLayer(marker);
        });
        xMarkers = [];
      }

      function updateBarricadeCount(count) {
        document.getElementById("count").textContent = count;
      }

      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      function showError(message) {
        document.getElementById("error-message").textContent = message;
        document.getElementById("error").style.display = "block";
        setTimeout(hideError, 5000);
      }

      function hideError() {
        document.getElementById("error").style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", initMap);

      function getlatlong() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            // console.log(`Latitude: ${latitude}, Longitude: ${longitude}`);
            document.getElementById(
              "latlong"
            ).innerHTML = `Latitude: ${latitude}, Longitude: ${longitude}`;
          });
        } else {
          console.log("Geolocation is not supported by this browser.");
        }
      }
    </script>
  </body>
</html>
